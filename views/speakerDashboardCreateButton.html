<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Speaker Dashboard – Create Story</title>

  <!-- Quill CSS -->
  <link rel="stylesheet" href="https://cdn.quilljs.com/1.3.6/quill.snow.css" />
  <!-- Your own styles -->
  <link rel="stylesheet" href="/cssStyles/speakerDashboardCreateButton.css">
</head>
<body>

<header>
  <h1>Welcome, <span id="speakerName">Speaker</span></h1>
</header>

<div class="container">
  <h2>Create New Story</h2>

  <form id="storyForm" enctype="multipart/form-data" onsubmit="return false;">
    <!-- ---------- IMAGE INPUT ---------- -->
    <div class="form-group">
      <label>Story Image</label>
      <div class="image-options">
        <input type="file" id="imageFile"  accept="image/*">
        <input type="text" id="imageUrl"  placeholder="…or paste image URL">
      </div>
    </div>

    <!-- ---------- EDITORS ---------- -->
    <div class="form-group"><label>Story Title</label><div id="titleEditor"        class="editor"></div></div>
    <div class="form-group"><label>Intro</label>       <div id="introEditor"        class="editor"></div></div>
    <div class="form-group"><label>Description</label> <div id="descriptionEditor"  class="editor"></div></div>

    <!-- ---------- YOUTUBE ---------- -->
    <div class="form-group">
      <label>YouTube Link (Optional)</label>
      <input type="text" id="youtubeBox" placeholder="https://youtube.com/…">
    </div>

    <!-- ---------- BUTTONS ---------- -->
    <div class="btn-row">
      <button type="button" class="post-btn"  id="publishBtn">🚀 Post Story</button>
      <button type="button" class="draft-btn" id="draftBtn">💾 Save Draft</button>
    </div>
  </form>
</div>

<!-- Quill JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
/* ------------------------------------------------------------------
   0.  BASIC USER INFO
------------------------------------------------------------------- */
const email = localStorage.getItem("email");
if (!email) { alert("Please log in first."); location.href = "login.html"; }

fetch(`/users/email/${encodeURIComponent(email)}`)
  .then(r => r.json())
  .then(d => { if (d.success && d.user) document.getElementById("speakerName").textContent = d.user.name || "Speaker"; })
  .catch(()=>{/* ignore */});

/* ------------------------------------------------------------------
   1.  TOOLBAR + IMAGE HANDLER  (unchanged – keep what you have)
------------------------------------------------------------------- */
const commonToolbar = [
  [{ header:[1,2,3,false] }], ['bold','italic','underline'],
  [{ color:[] },{ background:[] }], [{ align:[] }],
  ['link','image'], ['clean']
];

// popup with “Upload Image / Insert URL”
function selectImageHandler(e){
  const menu=document.createElement('div'); menu.className='tooltip-menu';

  const bUpload=document.createElement('button'); bUpload.textContent='Upload Image';
  bUpload.onclick=()=>{
    const inp=document.createElement('input'); inp.type='file'; inp.accept='image/*';
    inp.onchange=()=>{
      const f=inp.files[0]; if(!f) return;
      const r=new FileReader();
      r.onload=()=>{ const range=window.currentEditor.getSelection(); window.currentEditor.insertEmbed(range.index,'image',r.result); };
      r.readAsDataURL(f);
    };
    inp.click(); document.body.removeChild(menu);
  };

  const bURL=document.createElement('button'); bURL.textContent='Insert URL';
  bURL.onclick=()=>{
    const url=prompt("Enter image URL:");
    if(url){ const range=window.currentEditor.getSelection(); window.currentEditor.insertEmbed(range.index,'image',url); }
    document.body.removeChild(menu);
  };

  menu.appendChild(bUpload); menu.appendChild(bURL); document.body.appendChild(menu);
  menu.style.top=`${e.clientY}px`; menu.style.left=`${e.clientX}px`;
}

// register once
Quill.register('modules/customImage', function (q){
  const tb = q.getModule('toolbar');
  tb.addHandler('image', (e)=>{ window.currentEditor=q; selectImageHandler(e); });
});

/* ------------------------------------------------------------------
   2.  QUILL INSTANCES
------------------------------------------------------------------- */
const titleEditor = new Quill('#titleEditor',       { theme:'snow', placeholder:'Story title…',  modules:{ toolbar:commonToolbar }});
const introEditor = new Quill('#introEditor',       { theme:'snow', placeholder:'Intro…',         modules:{ toolbar:commonToolbar }});
const descriptionEditor = new Quill('#descriptionEditor',{
  theme:'snow', placeholder:'Full story…',
  modules:{ toolbar:commonToolbar, customImage:true }
});

/* ------------------------------------------------------------------
   3.  SUBMIT HELPER
------------------------------------------------------------------- */
function submitStory(status){                  // status = 'draft' | 'published'
  // --- grab once ---
  const titlePlain  = titleEditor.getText().trim();
  if(!titlePlain){ alert("❗ Please enter a Story Title."); return; }

  const intro       = introEditor.root.innerHTML.trim();
  const description = descriptionEditor.root.innerHTML.trim();
  const youtubeLink = document.getElementById("youtubeBox").value.trim();
  const imageFile   = document.getElementById("imageFile").files[0];
  const imageUrl    = document.getElementById("imageUrl").value.trim();

  // --- content validation ---
  if (status==="published") {
    if (!intro || !description){
      alert("Please complete Intro and Description before publishing."); return;
    }
    // at least one media item
    if (!imageFile && !imageUrl && !youtubeLink){
      alert("Please provide an image OR a YouTube link before publishing."); return;
    }
    // optional: avoid both
    if ((imageFile || imageUrl) && youtubeLink){
      alert("Please choose either an image OR a YouTube link, not both."); return;
    }
  }

  // --- build FormData ---
  const fd = new FormData();
  fd.append("email",  email);
  fd.append("status", status);          // draft / published
  fd.append("title",  titleEditor.root.innerHTML.trim());
  fd.append("intro",  intro);
  fd.append("description", description);
  fd.append("youtubeLink", youtubeLink);
  if (imageFile)     fd.append("image",    imageFile);
  else if (imageUrl) fd.append("imageUrl", imageUrl);

  // --- send ---
  fetch("/upload/uploadStory",{ method:"POST", body:fd })
    .then(r => r.json())
    .then(res=>{
      if(res.success){
        alert(status==="draft" ? "💾 Draft saved!" : "✅ Story published!");
        clearForm();
        // location.href="splSpeakershome.html"
        if(status==="published") location.href="splSpeakershome.html";
      } else {
        alert("❌ "+(res.message||"Failed."));
      }
    })
    .catch(err=>{ console.error(err); alert("Network / server error."); });
}

/* ------------------------------------------------------------------
   4.  BUTTON HOOKS  (unchanged)
------------------------------------------------------------------- */
document.getElementById("draftBtn")  .onclick = ()=>submitStory("draft");
document.getElementById("publishBtn").onclick = ()=>submitStory("published");

/* ------------------------------------------------------------------
   5.  CLEAR FORM
------------------------------------------------------------------- */
function clearForm(){
  [titleEditor,introEditor,descriptionEditor].forEach(ed=>ed.setContents([]));
  ["youtubeBox","imageFile","imageUrl"].forEach(id=>document.getElementById(id).value="");
}
</script>

</body>
</html>
